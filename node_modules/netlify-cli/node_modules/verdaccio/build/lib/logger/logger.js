"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createLogger = createLogger;
exports.getLogger = getLogger;
exports.logger = void 0;
exports.setup = setup;

var _debug = _interopRequireDefault(require("debug"));

var _lodash = _interopRequireDefault(require("lodash"));

var _pino = _interopRequireDefault(require("pino"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); enumerableOnly && (symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; })), keys.push.apply(keys, symbols); } return keys; }

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = null != arguments[i] ? arguments[i] : {}; i % 2 ? ownKeys(Object(source), !0).forEach(function (key) { _defineProperty(target, key, source[key]); }) : Object.getOwnPropertyDescriptors ? Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)) : ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function isProd() {
  return process.env.NODE_ENV === 'production';
}

let logger;
exports.logger = logger;
const debug = (0, _debug.default)('verdaccio:logger');
const DEFAULT_LOG_FORMAT = isProd() ? 'json' : 'pretty';

function createLogger(options = {
  level: 'http'
}, destination = _pino.default.destination(1), format = DEFAULT_LOG_FORMAT, prettyPrintOptions) {
  if (_lodash.default.isNil(format)) {
    format = DEFAULT_LOG_FORMAT;
  }

  let pinoConfig = _objectSpread(_objectSpread({
    customLevels: {
      http: 25
    }
  }, options), {}, {
    level: options.level,
    serializers: {
      err: _pino.default.stdSerializers.err,
      req: _pino.default.stdSerializers.req,
      res: _pino.default.stdSerializers.res
    }
  });

  debug('has prettifier? %o', !isProd()); // pretty logs are not allowed in production for performance reasons

  if ((format === DEFAULT_LOG_FORMAT || format !== 'json') && isProd() === false) {
    pinoConfig = Object.assign({}, pinoConfig, {
      // more info
      // https://github.com/pinojs/pino-pretty/issues/37
      prettyPrint: _objectSpread({
        levelFirst: true,
        prettyStamp: format === 'pretty-timestamped'
      }, prettyPrintOptions),
      prettifier: require('./formatter')
    });
  }

  const logger = (0, _pino.default)(pinoConfig, destination);

  if (process.env.DEBUG) {
    logger.on('level-change', (lvl, val, prevLvl, prevVal) => {
      debug('%s (%d) was changed to %s (%d)', lvl, val, prevLvl, prevVal);
    });
  }

  return logger;
}

function getLogger() {
  if (_lodash.default.isNil(logger)) {
    process.emitWarning('logger is not defined');
    return;
  }

  return logger;
}

const DEFAULT_LOGGER_CONF = {
  type: 'stdout',
  format: 'pretty',
  level: 'http',
  colors: true
};

function setup(options = [DEFAULT_LOGGER_CONF]) {
  var _loggerConfig, _loggerConfig2;

  debug('setup logger');
  const isLegacyConf = Array.isArray(options);

  if (isLegacyConf) {
    const deprecateMessage = 'deprecate: multiple logger configuration is deprecated, please check the migration guide.';
    process.emitWarning(deprecateMessage);
  } // verdaccio 5 does not allow multiple logger configuration
  // backward compatible, pick only the first option
  // next major will thrown an error


  let loggerConfig = isLegacyConf ? options[0] : options;

  if (!((_loggerConfig = loggerConfig) !== null && _loggerConfig !== void 0 && _loggerConfig.level)) {
    loggerConfig = Object.assign({}, {
      level: 'http'
    }, loggerConfig);
  }

  const pinoConfig = {
    level: loggerConfig.level
  };
  let colors = ((_loggerConfig2 = loggerConfig) === null || _loggerConfig2 === void 0 ? void 0 : _loggerConfig2.colors) === true ? process.stdout.isTTY : false;

  if ('EXPERIMENTAL_VERDACCIO_LOGGER_COLORS' in process.env) {
    colors = process.env.EXPERIMENTAL_VERDACCIO_LOGGER_COLORS != 'false';
  }

  const prettyPrintOptions = {
    // we hide warning since the prettifier should not be used in production
    // https://getpino.io/#/docs/pretty?id=prettifier-api
    suppressFlushSyncWarning: true,
    colors
  };

  if (loggerConfig.type === 'file') {
    debug('logging file enabled');

    const destination = _pino.default.destination(loggerConfig.path);

    process.on('SIGUSR2', () => destination.reopen());
    exports.logger = logger = createLogger(pinoConfig, destination, loggerConfig.format, prettyPrintOptions);
  } else if (loggerConfig.type === 'rotating-file') {
    process.emitWarning('rotating-file type is not longer supported, consider use [logrotate] instead');
    debug('logging stdout enabled');
    exports.logger = logger = createLogger(pinoConfig, _pino.default.destination(1), loggerConfig.format, prettyPrintOptions);
  } else {
    debug('logging stdout enabled');
    exports.logger = logger = createLogger(pinoConfig, _pino.default.destination(1), loggerConfig.format, prettyPrintOptions);
  }

  if (isProd()) {
    // why only on prod? https://github.com/pinojs/pino/issues/920#issuecomment-710807667
    const finalHandler = _pino.default.final(logger, (err, finalLogger, event) => {
      finalLogger.info(`${event} caught`);

      if (err) {
        finalLogger.error(err, 'error caused exit');
      }

      process.exit(err ? 1 : 0);
    });

    process.on('uncaughtException', err => finalHandler(err, 'uncaughtException'));
    process.on('unhandledRejection', err => finalHandler(err, 'unhandledRejection'));
    process.on('beforeExit', () => finalHandler(null, 'beforeExit'));
    process.on('exit', () => finalHandler(null, 'exit'));
    process.on('uncaughtException', err => finalHandler(err, 'uncaughtException'));
    process.on('SIGINT', () => finalHandler(null, 'SIGINT'));
    process.on('SIGQUIT', () => finalHandler(null, 'SIGQUIT'));
    process.on('SIGTERM', () => finalHandler(null, 'SIGTERM'));
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9saWIvbG9nZ2VyL2xvZ2dlci50cyJdLCJuYW1lcyI6WyJpc1Byb2QiLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJsb2dnZXIiLCJkZWJ1ZyIsIkRFRkFVTFRfTE9HX0ZPUk1BVCIsImNyZWF0ZUxvZ2dlciIsIm9wdGlvbnMiLCJsZXZlbCIsImRlc3RpbmF0aW9uIiwicGlubyIsImZvcm1hdCIsInByZXR0eVByaW50T3B0aW9ucyIsIl8iLCJpc05pbCIsInBpbm9Db25maWciLCJjdXN0b21MZXZlbHMiLCJodHRwIiwic2VyaWFsaXplcnMiLCJlcnIiLCJzdGRTZXJpYWxpemVycyIsInJlcSIsInJlcyIsIk9iamVjdCIsImFzc2lnbiIsInByZXR0eVByaW50IiwibGV2ZWxGaXJzdCIsInByZXR0eVN0YW1wIiwicHJldHRpZmllciIsInJlcXVpcmUiLCJERUJVRyIsIm9uIiwibHZsIiwidmFsIiwicHJldkx2bCIsInByZXZWYWwiLCJnZXRMb2dnZXIiLCJlbWl0V2FybmluZyIsIkRFRkFVTFRfTE9HR0VSX0NPTkYiLCJ0eXBlIiwiY29sb3JzIiwic2V0dXAiLCJpc0xlZ2FjeUNvbmYiLCJBcnJheSIsImlzQXJyYXkiLCJkZXByZWNhdGVNZXNzYWdlIiwibG9nZ2VyQ29uZmlnIiwic3Rkb3V0IiwiaXNUVFkiLCJFWFBFUklNRU5UQUxfVkVSREFDQ0lPX0xPR0dFUl9DT0xPUlMiLCJzdXBwcmVzc0ZsdXNoU3luY1dhcm5pbmciLCJwYXRoIiwicmVvcGVuIiwiZmluYWxIYW5kbGVyIiwiZmluYWwiLCJmaW5hbExvZ2dlciIsImV2ZW50IiwiaW5mbyIsImVycm9yIiwiZXhpdCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBOztBQUVBOztBQUNBOzs7Ozs7Ozs7O0FBRUEsU0FBU0EsTUFBVCxHQUFrQjtBQUNoQixTQUFPQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsUUFBWixLQUF5QixZQUFoQztBQUNEOztBQUVNLElBQUlDLE1BQUo7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QUFHLEdBQUcsQ0FBSCxHQUFPLENBQXZCO0FBQ0QsS0FOb0IsQ0FBckI7O0FBUUFuQixJQUFBQSxPQUFPLENBQUMrQixFQUFSLENBQVcsbUJBQVgsRUFBaUNaLEdBQUQsSUFBU2tDLFlBQVksQ0FBQ2xDLEdBQUQsRUFBTSxtQkFBTixDQUFyRDtBQUNBbkIsSUFBQUEsT0FBTyxDQUFDK0IsRUFBUixDQUFXLG9CQUFYLEVBQWtDWixHQUFELElBQVNrQyxZQUFZLENBQUNsQyxHQUFELEVBQWUsb0JBQWYsQ0FBdEQ7QUFDQW5CLElBQUFBLE9BQU8sQ0FBQytCLEVBQVIsQ0FBVyxZQUFYLEVBQXlCLE1BQU1zQixZQUFZLENBQUMsSUFBRCxFQUFPLFlBQVAsQ0FBM0M7QUFDQXJELElBQUFBLE9BQU8sQ0FBQytCLEVBQVIsQ0FBVyxNQUFYLEVBQW1CLE1BQU1zQixZQUFZLENBQUMsSUFBRCxFQUFPLE1BQVAsQ0FBckM7QUFDQXJELElBQUFBLE9BQU8sQ0FBQytCLEVBQVIsQ0FBVyxtQkFBWCxFQUFpQ1osR0FBRCxJQUFTa0MsWUFBWSxDQUFDbEMsR0FBRCxFQUFNLG1CQUFOLENBQXJEO0FBQ0FuQixJQUFBQSxPQUFPLENBQUMrQixFQUFSLENBQVcsUUFBWCxFQUFxQixNQUFNc0IsWUFBWSxDQUFDLElBQUQsRUFBTyxRQUFQLENBQXZDO0FBQ0FyRCxJQUFBQSxPQUFPLENBQUMrQixFQUFSLENBQVcsU0FBWCxFQUFzQixNQUFNc0IsWUFBWSxDQUFDLElBQUQsRUFBTyxTQUFQLENBQXhDO0FBQ0FyRCxJQUFBQSxPQUFPLENBQUMrQixFQUFSLENBQVcsU0FBWCxFQUFzQixNQUFNc0IsWUFBWSxDQUFDLElBQUQsRUFBTyxTQUFQLENBQXhDO0FBQ0Q7QUFDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBidWlsZERlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCB7IHllbGxvdyB9IGZyb20gJ2tsZXVyJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGlubyBmcm9tICdwaW5vJztcblxuZnVuY3Rpb24gaXNQcm9kKCkge1xuICByZXR1cm4gcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdwcm9kdWN0aW9uJztcbn1cblxuZXhwb3J0IGxldCBsb2dnZXI7XG5jb25zdCBkZWJ1ZyA9IGJ1aWxkRGVidWcoJ3ZlcmRhY2Npbzpsb2dnZXInKTtcbmNvbnN0IERFRkFVTFRfTE9HX0ZPUk1BVCA9IGlzUHJvZCgpID8gJ2pzb24nIDogJ3ByZXR0eSc7XG5cbmV4cG9ydCB0eXBlIExvZ1BsdWdpbiA9IHtcbiAgZGVzdDogc3RyaW5nO1xuICBvcHRpb25zPzogYW55W107XG59O1xuXG5leHBvcnQgdHlwZSBMb2dUeXBlID0gJ2ZpbGUnIHwgJ3N0ZG91dCc7XG5leHBvcnQgdHlwZSBMb2dGb3JtYXQgPSAnanNvbicgfCAncHJldHR5LXRpbWVzdGFtcGVkJyB8ICdwcmV0dHknO1xuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlTG9nZ2VyKG9wdGlvbnMgPSB7IGxldmVsOiAnaHR0cCcgfSwgZGVzdGluYXRpb24gPSBwaW5vLmRlc3RpbmF0aW9uKDEpLCBmb3JtYXQ6IExvZ0Zvcm1hdCA9IERFRkFVTFRfTE9HX0ZPUk1BVCwgcHJldHR5UHJpbnRPcHRpb25zKSB7XG4gIGlmIChfLmlzTmlsKGZvcm1hdCkpIHtcbiAgICBmb3JtYXQgPSBERUZBVUxUX0xPR19GT1JNQVQ7XG4gIH1cblxuICBsZXQgcGlub0NvbmZpZyA9IHtcbiAgICBjdXN0b21MZXZlbHM6IHtcbiAgICAgIGh0dHA6IDI1LFxuICAgIH0sXG4gICAgLi4ub3B0aW9ucyxcbiAgICBsZXZlbDogb3B0aW9ucy5sZXZlbCxcbiAgICBzZXJpYWxpemVyczoge1xuICAgICAgZXJyOiBwaW5vLnN0ZFNlcmlhbGl6ZXJzLmVycixcbiAgICAgIHJlcTogcGluby5zdGRTZXJpYWxpemVycy5yZXEsXG4gICAgICByZXM6IHBpbm8uc3RkU2VyaWFsaXplcnMucmVzLFxuICAgIH0sXG4gIH07XG5cbiAgZGVidWcoJ2hhcyBwcmV0dGlmaWVyPyAlbycsICFpc1Byb2QoKSk7XG4gIC8vIHByZXR0eSBsb2dzIGFyZSBub3QgYWxsb3dlZCBpbiBwcm9kdWN0aW9uIGZvciBwZXJmb3JtYW5jZSByZWFzb25zXG4gIGlmICgoZm9ybWF0ID09PSBERUZBVUxUX0xPR19GT1JNQVQgfHwgZm9ybWF0ICE9PSAnanNvbicpICYmIGlzUHJvZCgpID09PSBmYWxzZSkge1xuICAgIHBpbm9Db25maWcgPSBPYmplY3QuYXNzaWduKHt9LCBwaW5vQ29uZmlnLCB7XG4gICAgICAvLyBtb3JlIGluZm9cbiAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9waW5vanMvcGluby1wcmV0dHkvaXNzdWVzLzM3XG4gICAgICBwcmV0dHlQcmludDoge1xuICAgICAgICBsZXZlbEZpcnN0OiB0cnVlLFxuICAgICAgICBwcmV0dHlTdGFtcDogZm9ybWF0ID09PSAncHJldHR5LXRpbWVzdGFtcGVkJyxcbiAgICAgICAgLi4ucHJldHR5UHJpbnRPcHRpb25zLFxuICAgICAgfSxcbiAgICAgIHByZXR0aWZpZXI6IHJlcXVpcmUoJy4vZm9ybWF0dGVyJyksXG4gICAgfSk7XG4gIH1cbiAgY29uc3QgbG9nZ2VyID0gcGlubyhwaW5vQ29uZmlnLCBkZXN0aW5hdGlvbik7XG5cbiAgaWYgKHByb2Nlc3MuZW52LkRFQlVHKSB7XG4gICAgbG9nZ2VyLm9uKCdsZXZlbC1jaGFuZ2UnLCAobHZsLCB2YWwsIHByZXZMdmwsIHByZXZWYWwpID0+IHtcbiAgICAgIGRlYnVnKCclcyAoJWQpIHdhcyBjaGFuZ2VkIHRvICVzICglZCknLCBsdmwsIHZhbCwgcHJldkx2bCwgcHJldlZhbCk7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gbG9nZ2VyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TG9nZ2VyKCkge1xuICBpZiAoXy5pc05pbChsb2dnZXIpKSB7XG4gICAgcHJvY2Vzcy5lbWl0V2FybmluZygnbG9nZ2VyIGlzIG5vdCBkZWZpbmVkJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgcmV0dXJuIGxvZ2dlcjtcbn1cblxuY29uc3QgREVGQVVMVF9MT0dHRVJfQ09ORjogTG9nZ2VyQ29uZmlnSXRlbSA9IHtcbiAgdHlwZTogJ3N0ZG91dCcsXG4gIGZvcm1hdDogJ3ByZXR0eScsXG4gIGxldmVsOiAnaHR0cCcsXG4gIGNvbG9yczogdHJ1ZSxcbn07XG5cbmV4cG9ydCB0eXBlIExvZ2dlckNvbmZpZ0l0ZW0gPSB7XG4gIHR5cGU/OiBMb2dUeXBlO1xuICBwbHVnaW4/OiBMb2dQbHVnaW47XG4gIGZvcm1hdD86IExvZ0Zvcm1hdDtcbiAgcGF0aD86IHN0cmluZztcbiAgbGV2ZWw/OiBzdHJpbmc7XG4gIGNvbG9ycz86IGJvb2xlYW47XG59O1xuXG5leHBvcnQgdHlwZSBMb2dnZXJDb25maWcgPSBMb2dnZXJDb25maWdJdGVtW107XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXR1cChvcHRpb25zOiBMb2dnZXJDb25maWcgfCBMb2dnZXJDb25maWdJdGVtID0gW0RFRkFVTFRfTE9HR0VSX0NPTkZdKSB7XG4gIGRlYnVnKCdzZXR1cCBsb2dnZXInKTtcbiAgY29uc3QgaXNMZWdhY3lDb25mID0gQXJyYXkuaXNBcnJheShvcHRpb25zKTtcbiAgaWYgKGlzTGVnYWN5Q29uZikge1xuICAgIGNvbnN0IGRlcHJlY2F0ZU1lc3NhZ2UgPSAnZGVwcmVjYXRlOiBtdWx0aXBsZSBsb2dnZXIgY29uZmlndXJhdGlvbiBpcyBkZXByZWNhdGVkLCBwbGVhc2UgY2hlY2sgdGhlIG1pZ3JhdGlvbiBndWlkZS4nO1xuICAgIHByb2Nlc3MuZW1pdFdhcm5pbmcoZGVwcmVjYXRlTWVzc2FnZSk7XG4gIH1cblxuICAvLyB2ZXJkYWNjaW8gNSBkb2VzIG5vdCBhbGxvdyBtdWx0aXBsZSBsb2dnZXIgY29uZmlndXJhdGlvblxuICAvLyBiYWNrd2FyZCBjb21wYXRpYmxlLCBwaWNrIG9ubHkgdGhlIGZpcnN0IG9wdGlvblxuICAvLyBuZXh0IG1ham9yIHdpbGwgdGhyb3duIGFuIGVycm9yXG4gIGxldCBsb2dnZXJDb25maWcgPSBpc0xlZ2FjeUNvbmYgPyBvcHRpb25zWzBdIDogb3B0aW9ucztcbiAgaWYgKCFsb2dnZXJDb25maWc/LmxldmVsKSB7XG4gICAgbG9nZ2VyQ29uZmlnID0gT2JqZWN0LmFzc2lnbihcbiAgICAgIHt9LFxuICAgICAge1xuICAgICAgICBsZXZlbDogJ2h0dHAnLFxuICAgICAgfSxcbiAgICAgIGxvZ2dlckNvbmZpZ1xuICAgICk7XG4gIH1cbiAgY29uc3QgcGlub0NvbmZpZyA9IHsgbGV2ZWw6IGxvZ2dlckNvbmZpZy5sZXZlbCB9O1xuICBsZXQgY29sb3JzID0gbG9nZ2VyQ29uZmlnPy5jb2xvcnMgPT09IHRydWUgPyBwcm9jZXNzLnN0ZG91dC5pc1RUWSA6IGZhbHNlO1xuICBpZiAoJ0VYUEVSSU1FTlRBTF9WRVJEQUNDSU9fTE9HR0VSX0NPTE9SUycgaW4gcHJvY2Vzcy5lbnYpIHtcbiAgICBjb2xvcnMgPSBwcm9jZXNzLmVudi5FWFBFUklNRU5UQUxfVkVSREFDQ0lPX0xPR0dFUl9DT0xPUlMgIT0gJ2ZhbHNlJztcbiAgfVxuICBjb25zdCBwcmV0dHlQcmludE9wdGlvbnMgPSB7XG4gICAgLy8gd2UgaGlkZSB3YXJuaW5nIHNpbmNlIHRoZSBwcmV0dGlmaWVyIHNob3VsZCBub3QgYmUgdXNlZCBpbiBwcm9kdWN0aW9uXG4gICAgLy8gaHR0cHM6Ly9nZXRwaW5vLmlvLyMvZG9jcy9wcmV0dHk/aWQ9cHJldHRpZmllci1hcGlcbiAgICBzdXBwcmVzc0ZsdXNoU3luY1dhcm5pbmc6IHRydWUsXG4gICAgY29sb3JzLFxuICB9O1xuICBpZiAobG9nZ2VyQ29uZmlnLnR5cGUgPT09ICdmaWxlJykge1xuICAgIGRlYnVnKCdsb2dnaW5nIGZpbGUgZW5hYmxlZCcpO1xuICAgIGNvbnN0IGRlc3RpbmF0aW9uID0gcGluby5kZXN0aW5hdGlvbihsb2dnZXJDb25maWcucGF0aCk7XG4gICAgcHJvY2Vzcy5vbignU0lHVVNSMicsICgpID0+IGRlc3RpbmF0aW9uLnJlb3BlbigpKTtcbiAgICBsb2dnZXIgPSBjcmVhdGVMb2dnZXIocGlub0NvbmZpZywgZGVzdGluYXRpb24sIGxvZ2dlckNvbmZpZy5mb3JtYXQsIHByZXR0eVByaW50T3B0aW9ucyk7XG4gIH0gZWxzZSBpZiAobG9nZ2VyQ29uZmlnLnR5cGUgPT09ICdyb3RhdGluZy1maWxlJykge1xuICAgIHByb2Nlc3MuZW1pdFdhcm5pbmcoJ3JvdGF0aW5nLWZpbGUgdHlwZSBpcyBub3QgbG9uZ2VyIHN1cHBvcnRlZCwgY29uc2lkZXIgdXNlIFtsb2dyb3RhdGVdIGluc3RlYWQnKTtcbiAgICBkZWJ1ZygnbG9nZ2luZyBzdGRvdXQgZW5hYmxlZCcpO1xuICAgIGxvZ2dlciA9IGNyZWF0ZUxvZ2dlcihwaW5vQ29uZmlnLCBwaW5vLmRlc3RpbmF0aW9uKDEpLCBsb2dnZXJDb25maWcuZm9ybWF0LCBwcmV0dHlQcmludE9wdGlvbnMpO1xuICB9IGVsc2Uge1xuICAgIGRlYnVnKCdsb2dnaW5nIHN0ZG91dCBlbmFibGVkJyk7XG4gICAgbG9nZ2VyID0gY3JlYXRlTG9nZ2VyKHBpbm9Db25maWcsIHBpbm8uZGVzdGluYXRpb24oMSksIGxvZ2dlckNvbmZpZy5mb3JtYXQsIHByZXR0eVByaW50T3B0aW9ucyk7XG4gIH1cblxuICBpZiAoaXNQcm9kKCkpIHtcbiAgICAvLyB3aHkgb25seSBvbiBwcm9kPyBodHRwczovL2dpdGh1Yi5jb20vcGlub2pzL3Bpbm8vaXNzdWVzLzkyMCNpc3N1ZWNvbW1lbnQtNzEwODA3NjY3XG4gICAgY29uc3QgZmluYWxIYW5kbGVyID0gcGluby5maW5hbChsb2dnZXIsIChlcnIsIGZpbmFsTG9nZ2VyLCBldmVudCkgPT4ge1xuICAgICAgZmluYWxMb2dnZXIuaW5mbyhgJHtldmVudH0gY2F1Z2h0YCk7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIGZpbmFsTG9nZ2VyLmVycm9yKGVyciwgJ2Vycm9yIGNhdXNlZCBleGl0Jyk7XG4gICAgICB9XG4gICAgICBwcm9jZXNzLmV4aXQoZXJyID8gMSA6IDApO1xuICAgIH0pO1xuXG4gICAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCAoZXJyKSA9PiBmaW5hbEhhbmRsZXIoZXJyLCAndW5jYXVnaHRFeGNlcHRpb24nKSk7XG4gICAgcHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgKGVycikgPT4gZmluYWxIYW5kbGVyKGVyciBhcyBFcnJvciwgJ3VuaGFuZGxlZFJlamVjdGlvbicpKTtcbiAgICBwcm9jZXNzLm9uKCdiZWZvcmVFeGl0JywgKCkgPT4gZmluYWxIYW5kbGVyKG51bGwsICdiZWZvcmVFeGl0JykpO1xuICAgIHByb2Nlc3Mub24oJ2V4aXQnLCAoKSA9PiBmaW5hbEhhbmRsZXIobnVsbCwgJ2V4aXQnKSk7XG4gICAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCAoZXJyKSA9PiBmaW5hbEhhbmRsZXIoZXJyLCAndW5jYXVnaHRFeGNlcHRpb24nKSk7XG4gICAgcHJvY2Vzcy5vbignU0lHSU5UJywgKCkgPT4gZmluYWxIYW5kbGVyKG51bGwsICdTSUdJTlQnKSk7XG4gICAgcHJvY2Vzcy5vbignU0lHUVVJVCcsICgpID0+IGZpbmFsSGFuZGxlcihudWxsLCAnU0lHUVVJVCcpKTtcbiAgICBwcm9jZXNzLm9uKCdTSUdURVJNJywgKCkgPT4gZmluYWxIYW5kbGVyKG51bGwsICdTSUdURVJNJykpO1xuICB9XG59XG4iXX0=